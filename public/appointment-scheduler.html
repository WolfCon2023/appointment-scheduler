<script>
    const API_BASE_URL = "https://vital-backoffice-apps-production-8f97.up.railway.app/api";

    document.addEventListener('DOMContentLoaded', async function () {
        console.log("DOM Loaded");

        const modal = document.getElementById('calendarModal');
        const openCalendarBtn = document.getElementById('openCalendar');
        const closeCalendarBtn = document.getElementById('closeCalendar');
        const modalCalendarEl = document.getElementById('modalCalendar');
        const addAppointmentButton = document.getElementById('addAppointment');

        let modalCalendar;
        let appointmentData = {}; 

        async function fetchAppointments() {
            try {
                const response = await fetch(`${API_BASE_URL}/appointments`);
                const appointments = await response.json();
                appointmentData = appointments.reduce((acc, appt) => ({...acc, [appt.id]: appt}), {});
                return appointments.map(appt => ({ id: appt.id, title: appt.title, start: appt.date }));
            } catch (error) {
                console.error("Error fetching appointments:", error);
                return [];
            }
        }

        openCalendarBtn.addEventListener('click', async () => {
            modal.style.display = 'flex';

            if (!modalCalendar) {
                const events = await fetchAppointments();

                modalCalendar = new FullCalendar.Calendar(modalCalendarEl, {
                    initialView: "dayGridMonth",
                    headerToolbar: { left: "prev,next today", center: "title", right: "dayGridMonth,timeGridWeek,timeGridDay" },
                    events: events,
                    eventClick: function(info) {  
                        info.jsEvent.preventDefault();
                        const data = appointmentData[info.event.id];

                        document.getElementById('detailsContent').innerHTML = `
                            <strong>Title:</strong> ${data.title}<br>
                            <strong>Date:</strong> ${new Date(data.date).toLocaleString()}<br>
                            <strong>Location:</strong> ${data.location}<br>
                            <strong>Contact Name:</strong> ${data.contactName}<br>
                            <strong>Phone:</strong> ${data.contactPhone}<br>
                            <strong>Email:</strong> ${data.contactEmail}<br>
                            <strong>Scheduled By:</strong> ${data.scheduledBy}<br>
                            <strong>Notes:</strong> ${data.notes}<br>
                        `;

                        document.getElementById('appointmentDetailsModal').style.display = 'flex';
                    }
                });

                modalCalendar.render();
            }
        });

        closeCalendarBtn.addEventListener('click', () => modal.style.display = 'none');

        // **âœ… Fix Add Appointment Error Handling & Database Upload**
        addAppointmentButton.addEventListener('click', async () => {
            const title = document.getElementById('appointmentTitle');
            const date = document.getElementById('appointmentDate');
            const location = document.getElementById('appointmentLocation');
            const contactName = document.getElementById('contactName');
            const contactPhone = document.getElementById('contactPhoneNumber');
            const contactEmail = document.getElementById('contactEmail');
            const scheduledBy = document.getElementById('scheduledBy');
            const notes = document.getElementById('appointmentNotes');

            // **Check Required Fields**
            const requiredFields = [title, date, location, contactName, contactPhone, contactEmail, scheduledBy];
            let valid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.border = "2px solid red";
                    valid = false;
                } else {
                    field.style.border = ""; // Reset border color if filled
                }
            });

            if (!valid) {
                alert("Please fill out all required fields.");
                return;
            }

            // **Create Appointment Object**
            const newAppointment = {
                title: title.value.trim(),
                date: date.value,
                location: location.value.trim(),
                contactName: contactName.value.trim(),
                contactPhone: contactPhone.value.trim(),
                contactEmail: contactEmail.value.trim(),
                scheduledBy: scheduledBy.value.trim(),
                notes: notes.value.trim()
            };

            try {
                const response = await fetch(`${API_BASE_URL}/appointments`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newAppointment)
                });

                if (response.ok) {
                    alert("Appointment added successfully!");

                    // **Immediately Add to Calendar Without Reload**
                    if (modalCalendar) {
                        modalCalendar.addEvent({
                            id: newAppointment.id, // API should return ID, but using temp workaround
                            title: newAppointment.title,
                            start: newAppointment.date
                        });
                    }

                    // **Clear Form Fields After Successful Submission**
                    requiredFields.forEach(field => field.value = "");
                    notes.value = "";

                } else {
                    alert("Failed to add appointment. Please try again.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Error adding appointment. Please check your internet connection.");
            }
        });
    });
</script>
